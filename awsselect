#!/bin/bash

CONFIG_LINE='export AWS_PROFILE=$(cat ~/.aws/selected_profile 2>/dev/null)'

install_persistence() {
  shell_rc=""
  if [ -f "$HOME/.zshrc" ]; then
    shell_rc="$HOME/.zshrc"
  elif [ -f "$HOME/.bashrc" ]; then
    shell_rc="$HOME/.bashrc"
  else
    echo "âš ï¸  No se encontrÃ³ .bashrc ni .zshrc. Agregalo manualmente:"
    echo "$CONFIG_LINE"
    exit 1
  fi

  # Verificar si ya existe la lÃ­nea
  if grep -Fxq "$CONFIG_LINE" "$shell_rc"; then
    echo "âœ… ConfiguraciÃ³n ya existe en $shell_rc"
  else
    echo -e "\n# AWS profile auto-cargado por awsselect\n$CONFIG_LINE" >> "$shell_rc"
    echo "âœ… ConfiguraciÃ³n agregada a $shell_rc"
  fi

  echo "ğŸ’¡ AbrÃ­ una nueva terminal o ejecutÃ¡:"
  echo "source $shell_rc"
}

# Modo instalaciÃ³n
if [[ "$1" == "install" ]]; then
  install_persistence
  exit 0
fi

# SelecciÃ³n de perfil interactiva
profiles=$(awk -F'[][]' '/\[.*\]/{print $2}' ~/.aws/credentials)

if [ -z "$profiles" ]; then
  echo "âš ï¸  No se encontraron perfiles en ~/.aws/credentials"
  exit 1
fi

echo "ğŸ” Perfiles disponibles:"
select profile in $profiles; do
  if [ -n "$profile" ]; then
    echo "$profile" > ~/.aws/selected_profile
    export AWS_PROFILE="$profile"
    echo "âœ… Perfil AWS seleccionado: $profile"

    identity=$(aws sts get-caller-identity --output text 2>/dev/null)
    if [ $? -eq 0 ]; then
      echo "ğŸ” Cuenta activa:"
      echo "$identity"
    else
      echo "âš ï¸  No se pudo verificar la identidad con 'aws sts get-caller-identity'"
    fi
    break
  else
    echo "âŒ OpciÃ³n invÃ¡lida. IntentÃ¡ de nuevo."
  fi
done