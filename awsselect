#!/bin/bash

# Herramienta interactiva para cambiar entre perfiles de AWS CLI

profiles=$(awk -F'[][]' '/\[.*\]/{print $2}' ~/.aws/credentials)

if [ -z "$profiles" ]; then
  echo "âš ï¸  No se encontraron perfiles en ~/.aws/credentials"
  exit 1
fi

echo "ğŸ” Perfiles disponibles:"
select profile in $profiles; do
  if [ -n "$profile" ]; then
    echo "$profile" > ~/.aws/selected_profile

    # Detectar si ~/.zshrc o ~/.bashrc ya exporta AWS_PROFILE
    profile_autoloaded=false
    if grep -q 'AWS_PROFILE=.*selected_profile' ~/.zshrc 2>/dev/null || grep -q 'AWS_PROFILE=.*selected_profile' ~/.bashrc 2>/dev/null; then
      profile_autoloaded=true
    else
      echo "" >> ~/.zshrc
      echo "# Auto-carga de AWS_PROFILE agregado por awsselect" >> ~/.zshrc
      echo 'export AWS_PROFILE=$(cat ~/.aws/selected_profile 2>/dev/null)' >> ~/.zshrc
    fi

    identity=$(aws sts get-caller-identity --output text 2>/dev/null)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Perfil AWS seleccionado: $profile"
    echo "ğŸ“ Guardado en: ~/.aws/selected_profile"
    if [ "$profile_autoloaded" = false ]; then
      echo "ğŸ› ï¸  AÃ±adido automÃ¡ticamente a ~/.zshrc"
    fi

    if [ $? -eq 0 ]; then
      echo ""
      echo "ğŸ” Cuenta activa:"
      echo "$identity"
    else
      echo "âš ï¸  No se pudo verificar la identidad con 'aws sts get-caller-identity'"
    fi

    echo ""
    echo "ğŸš€ El perfil se aplicarÃ¡ automÃ¡ticamente en TODAS las terminales nuevas."
    echo "ğŸ‘‰ Si querÃ©s aplicarlo ahora mismo, ejecutÃ¡:"
    echo ""
    echo "   export AWS_PROFILE=$profile"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    break
  else
    echo "âŒ OpciÃ³n invÃ¡lida. IntentÃ¡ de nuevo."
  fi
done
